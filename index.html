<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MCATable - Your Guide To MCAT Prep</title>
    <link
      rel="icon"
      type="image/png"
      href="Screenshot 2025-09-18 at 9.21.54 PM.png"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* Add this to your existing CSS in index.html */

      /* Fixed banner at top */
      .auth-banner {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 9999;
        background: #2d82a4;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding: 10px 20px;
        font-family: Arial, sans-serif;
        font-size: 13px;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-height: 55px;
      }

      /* Adjust body to account for fixed banner */
      body {
        padding-top: 75px; /* Keep this */
        margin: 0;
        font-family: "Inter", "Roboto", Arial, sans-serif;
        min-height: 100vh;
        background: linear-gradient(120deg, #731e7a 0%, #8b25eb 60%, #06b6d4 100%);
        animation: bgmove 12s ease-in-out infinite alternate;
      }

      @keyframes bgmove {
        0% {
          background-position: 0% 50%;
        }
        100% {
          background-position: 100% 50%;
        }
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
          filter: drop-shadow(0 0 0px #ace9ff);
        }
        50% {
          transform: scale(1.05);
          filter: drop-shadow(0 0 16px #a771ff);
        }
        100% {
          transform: scale(1);
          filter: drop-shadow(0 0 0px #a771ff);
        }
      }

      header {
        background: rgba(225, 242, 255, 0.85);
        box-shadow: 0 2px 12px rgba(30, 41, 59, 0.08);
        padding: 1.5rem 0 1.2rem 0;
        text-align: center;
        border-bottom: 1px solid #032770;
      }

      .logo-title {
        font-size: 2.6rem;
        font-weight: 900;
        color: #2f086e;
        letter-spacing: -2px;
        background: linear-gradient(90deg, #027696 30%, #82038e 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      main {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 80vh;
      }

      .card {
        background: rgba(238, 254, 255, 0.97);
        border-radius: 1.2rem;
        box-shadow: 0 8px 32px rgba(30, 41, 59, 0.18), 0 1.5px 8px #06b6d4;
        padding: 2.7rem 2.2rem;
        max-width: 440px;
        width: 100%;
        text-align: center;
        margin: 20px;
      }

      h1 {
        font-size: 2.1rem;
        font-weight: 800;
        color: #1e293b;
        margin-bottom: 0.6em;
        letter-spacing: -0.5px;
      }

      p {
        font-size: 1.13rem;
        color: #334155;
        margin-bottom: 2em;
        line-height: 1.6;
      }

      .button {
        display: inline-block;
        padding: 0.85em 2.5em;
        background: linear-gradient(90deg, #2563eb 0%, #06b6d4 100%);
        color: #fff;
        font-weight: 700;
        border-radius: 0.6rem;
        text-decoration: none;
        font-size: 1.13rem;
        box-shadow: 0 2px 16px #06b6d4a0;
        transition: all 0.2s;
        margin: 10px;
        border: none;
        cursor: pointer;
      }

      .button:hover {
        background: linear-gradient(90deg, #06b6d4 0%, #2563eb 100%);
        transform: translateY(-2px) scale(1.04);
      }

      .nav-link {
        margin-right: 1.5rem;
        color: #001868;
        font-weight: 600;
        text-decoration: none;
        background-color: #06b6d4;
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
      }

      /* Simple Login Box */
      .login-box {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        font-size: 14px;
        min-width: 250px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
      }

      .form-group input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
      }

      .auth-button {
        width: 100%;
        padding: 10px;
        background: #4285f4;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-bottom: 10px;
      }

      .auth-button:hover {
        background: #3367d6;
      }

      .auth-button.google {
        background: #db4437;
      }

      .auth-button.google:hover {
        background: #c23321;
      }

      .switch-link {
        color: #4285f4;
        cursor: pointer;
        text-decoration: underline;
        font-size: 12px;
      }

      .hidden {
        display: none;
      }

      .user-info {
        text-align: center;
      }

      .user-email {
        font-size: 12px;
        color: #666;
        margin: 10px 0;
      }

      .message {
        padding: 8px;
        border-radius: 4px;
        margin: 10px 0;
        font-size: 12px;
        text-align: center;
      }

      .success {
        background: #d4edda;
        color: #155724;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
      }

      /* Banner left section */
      .banner-left {
        display: flex;
        align-items: center;
        gap: 12px;
        color: white;
      }

      .banner-logo {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        border: 2px solid rgba(255, 255, 255, 0.3);
      }

      .banner-text h3 {
        font-weight: bold;
        font-size: 16px;
        margin: 0;
        color: white;
      }

      .banner-text p {
        font-size: 11px;
        opacity: 0.9;
        margin: 0;
        color: rgba(255, 255, 255, 0.9);
      }

      /* Banner right section - auth controls */
      .banner-auth {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .banner-status {
        color: white;
        font-size: 12px;
        opacity: 0.9;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .banner-button {
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.2s ease;
        backdrop-filter: blur(5px);
      }

      .banner-button:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
      }

      .banner-button.logout {
        background: rgba(239, 68, 68, 0.8);
        border-color: rgba(239, 68, 68, 0.3);
      }

      .banner-button.logout:hover {
        background: rgba(239, 68, 68, 1);
      }

      .user-avatar-banner {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 14px;
        border: 2px solid rgba(255, 255, 255, 0.3);
      }

      /* Hide old login box when banner is active */
      .login-box {
        display: none;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .auth-banner {
          flex-direction: column;
          padding: 8px 15px;
          min-height: auto;
        }

        .banner-left {
          margin-bottom: 8px;
        }

        body {
          padding-top: 95px;
        }
      }
    </style>
  </head>

  <body>
    <!-- Auth Banner -->
    <div class="auth-banner">
      <div class="banner-left">
        <div class="banner-logo">M</div>
        <div class="banner-text">
          <h3>MCATable</h3>
          <p>Your guide to MCAT success</p>
        </div>
      </div>
      <div class="banner-auth">
        <div class="banner-status" id="auth-status"></div>
        <button id="login-btn-banner" class="banner-button">Sign In</button>
        <button id="register-btn-banner" class="banner-button">Sign Up</button>
      </div>
    </div>

    <main>
      <div style="font-size: 80px; color: rgb(179, 233, 255)">
        <span style="display: inline-block; animation: pulse 1.2s infinite"
          >⚕</span
        >
      </div>
      <br />

      <div class="card">
        <h1>Start Your MCAT Journey</h1>
        <p>
          Comprehensive review, practice questions, and study resources to help
          you succeed on the MCAT<sup>®</sup>.
        </p>

        <a href="miledown_genchem.html" class="button">Practice</a>
        <a href="main.html" class="button">Dashboard</a>
      </div>
    </main>

    <!-- Auth Banner -->
    <div id="auth-banner" class="auth-banner">
      <div class="banner-left">
        <div class="banner-logo">⚕</div>
        <div class="banner-text">
          <h3>MCATable</h3>
          <p id="banner-status">Authentication System</p>
        </div>
      </div>

      <div class="banner-auth">
        <!-- Not signed in state -->
        <div id="banner-signed-out" class="banner-status">
          <span> Not signed in</span>
          <button id="banner-login-btn" class="banner-button">Sign In</button>
        </div>

        <!-- Signed in state -->
        <div id="banner-signed-in" class="banner-status" style="display: none">
          <div class="user-avatar-banner" id="banner-user-avatar">U</div>
          <div style="margin-right: 10px">
            <div
              id="banner-user-name"
              style="font-weight: bold; font-size: 12px"
            >
              User
            </div>
            <div style="font-size: 10px; opacity: 0.8">
              Syncing across devices
            </div>
          </div>
          <button id="banner-logout-btn" class="banner-button logout">
            Sign Out
          </button>
        </div>
      </div>
    </div>

    <!-- Login Modal (hidden by default) -->
    <div
      id="login-modal"
      class="login-box"
      style="
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10000;
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        min-width: 300px;
      "
    >
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
        "
      >
        <h3 style="margin: 0">Authentication</h3>
        <button
          id="close-modal"
          style="
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
          "
        >
          &times;
        </button>
      </div>

      <!-- Login Form -->
      <div id="login-form">
        <div class="form-group">
          <label for="login-email">Email</label>
          <input type="email" id="login-email" placeholder="Enter your email" />
        </div>
        <div class="form-group">
          <label for="login-password">Password</label>
          <input
            type="password"
            id="login-password"
            placeholder="Enter your password"
          />
        </div>
        <button id="login-btn" class="auth-button">Sign In</button>
        <button id="google-login-btn" class="auth-button google">
          Sign In with Google
        </button>
        <div style="text-align: center">
          <span class="switch-link" id="show-register"
            >Don't have an account? Sign up</span
          >
        </div>
      </div>

      <!-- Register Form -->
      <div id="register-form" class="hidden">
        <div class="form-group">
          <label for="register-email">Email</label>
          <input
            type="email"
            id="register-email"
            placeholder="Enter your email"
          />
        </div>
        <div class="form-group">
          <label for="register-password">Password</label>
          <input
            type="password"
            id="register-password"
            placeholder="Create a password"
          />
        </div>
        <button id="register-btn" class="auth-button">Create Account</button>
        <div style="text-align: center">
          <span class="switch-link" id="show-login"
            >Already have an account? Sign in</span
          >
        </div>
      </div>

      <!-- Messages -->
      <div id="message"></div>
    </div>

    <!-- Modal backdrop -->
    <div
      id="modal-backdrop"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
      "
      onclick="closeModal()"
    ></div>

    <!-- Firebase -->
    <script type="module">
      // Import Firebase
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signInWithPopup,
        GoogleAuthProvider,
        signOut,
        onAuthStateChanged,
        setPersistence,
        browserSessionPersistence
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        collection,
        onSnapshot,
        serverTimestamp
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyAxvvxY1q9CmPB5YoS-cFzfSwkjVqYQ5s0",
        authDomain: "percentyle.firebaseapp.com",
        databaseURL: "https://percentyle-default-rtdb.firebaseio.com",
        projectId: "percentyle",
        storageBucket: "percentyle.firebasestorage.app",
        messagingSenderId: "601930251108",
        appId: "1:601930251108:web:987d2d7b5ba9ca30f75871",
        measurementId: "G-L97LGZSXS5",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const googleProvider = new GoogleAuthProvider();

      // Set Firebase persistence (replaces localStorage)
      setPersistence(auth, browserSessionPersistence);

      // DOM elements
      const loginForm = document.getElementById("login-form");
      const registerForm = document.getElementById("register-form");
      const messageDiv = document.getElementById("message");

      // Show message
      function showMessage(text, type = "success") {
        messageDiv.className = `message ${type}`;
        messageDiv.textContent = text;
        setTimeout(() => {
          messageDiv.textContent = "";
          messageDiv.className = "";
        }, 5000);
      }

      // Modal control functions
      function openModal() {
        document.getElementById("login-modal").style.display = "block";
        document.getElementById("modal-backdrop").style.display = "block";
        document.body.style.overflow = "hidden";
        console.log("Modal opened");
      }

      function closeModal() {
        document.getElementById("login-modal").style.display = "none";
        document.getElementById("modal-backdrop").style.display = "none";
        document.body.style.overflow = "auto";
        console.log("Modal closed");
      }

      // Update banner status
      function updateBannerStatus(message) {
        const bannerStatus = document.getElementById("banner-status");
        if (bannerStatus) {
          bannerStatus.textContent = message;
        }
      }

      // Firebase-only user session management
      const saveUserSession = async (user) => {
        if (!user) return;
        
        try {
          await setDoc(doc(db, 'userSessions', user.uid), {
            email: user.email,
            displayName: user.displayName,
            photoURL: user.photoURL,
            lastActive: serverTimestamp(),
            deviceInfo: navigator.userAgent,
            sessionId: crypto.randomUUID()
          });
          
          console.log("User session saved to Firebase");
        } catch (error) {
          console.error("Failed to save user session:", error);
        }
      };

      const removeUserSession = async (uid) => {
        if (!uid) return;
        
        try {
          await setDoc(doc(db, 'userSessions', uid), {
            lastActive: serverTimestamp(),
            sessionEnded: true
          }, { merge: true });
          
          console.log("User session ended in Firebase");
        } catch (error) {
          console.error("Failed to end user session:", error);
        }
      };

      // Global functions for quiz pages (Firebase-only)
      window.saveQuizData = async (quizName, answers) => {
        if (!window.currentUser) {
          console.log("No user - cannot save to Firebase");
          return false;
        }

        try {
          await setDoc(doc(db, 'users', window.currentUser.uid, 'quizzes', quizName), {
            answers: answers,
            lastUpdated: serverTimestamp(),
            quizName: quizName,
            totalQuestions: Object.keys(answers).length,
            userAgent: navigator.userAgent,
            url: window.location.href
          });
          
          console.log(`Quiz ${quizName} saved to Firebase`);
          return true;
        } catch (error) {
          console.error("Failed to save quiz data:", error);
          return false;
        }
      };

      window.loadQuizData = async (quizName) => {
        if (!window.currentUser) {
          console.log("No user - cannot load from Firebase");
          return {};
        }

        try {
          const docSnap = await getDoc(doc(db, 'users', window.currentUser.uid, 'quizzes', quizName));
          if (docSnap.exists()) {
            const data = docSnap.data();
            console.log(`Quiz ${quizName} loaded from Firebase`);
            return data.answers || {};
          }
          return {};
        } catch (error) {
          console.error("Failed to load quiz data:", error);
          return {};
        }
      };

      window.setupQuizSync = (quizName, callback) => {
        if (!window.currentUser) return null;

        const docRef = doc(db, 'users', window.currentUser.uid, 'quizzes', quizName);
        return onSnapshot(docRef, (docSnap) => {
          if (docSnap.exists()) {
            const data = docSnap.data();
            callback(data.answers || {});
          }
        });
      };

      // Event handlers
      document.getElementById("banner-login-btn").onclick = openModal;
      document.getElementById("close-modal").onclick = closeModal;
      document.getElementById("modal-backdrop").onclick = closeModal;

      // Form switching
      document.getElementById("show-register").onclick = () => {
        loginForm.classList.add("hidden");
        registerForm.classList.remove("hidden");
      };

      document.getElementById("show-login").onclick = () => {
        registerForm.classList.add("hidden");
        loginForm.classList.remove("hidden");
      };

      // Email/Password Sign Up
      document.getElementById("register-btn").onclick = async () => {
        const email = document.getElementById("register-email").value.trim();
        const password = document.getElementById("register-password").value;

        if (!email || !password) {
          showMessage("Please fill in all fields", "error");
          return;
        }

        if (password.length < 6) {
          showMessage("Password must be at least 6 characters", "error");
          return;
        }

        try {
          document.getElementById("register-btn").textContent = "Creating...";
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          
          // Save user profile to Firebase (replaces localStorage)
          await setDoc(doc(db, 'users', userCredential.user.uid), {
            email: email,
            createdAt: serverTimestamp(),
            quizProgress: {},
            preferences: {
              theme: 'default',
              notifications: true
            }
          });
          
          showMessage("Account created successfully!");
        } catch (error) {
          showMessage(error.message, "error");
        } finally {
          document.getElementById("register-btn").textContent = "Create Account";
        }
      };

      // Email/Password Sign In
      document.getElementById("login-btn").onclick = async () => {
        const email = document.getElementById("login-email").value.trim();
        const password = document.getElementById("login-password").value;

        if (!email || !password) {
          showMessage("Please fill in all fields", "error");
          return;
        }

        try {
          document.getElementById("login-btn").textContent = "Signing in...";
          await signInWithEmailAndPassword(auth, email, password);
          showMessage("Signed in successfully!");
        } catch (error) {
          showMessage(error.message, "error");
        } finally {
          document.getElementById("login-btn").textContent = "Sign In";
        }
      };

      // Google Sign In
      document.getElementById("google-login-btn").onclick = async () => {
        try {
          document.getElementById("google-login-btn").textContent = "Signing in...";
          const result = await signInWithPopup(auth, googleProvider);
          
          // Save Google user profile to Firebase
          await setDoc(doc(db, 'users', result.user.uid), {
            email: result.user.email,
            displayName: result.user.displayName,
            photoURL: result.user.photoURL,
            provider: 'google',
            lastSignIn: serverTimestamp(),
            quizProgress: {},
            preferences: {
              theme: 'default',
              notifications: true
            }
          }, { merge: true });
          
          showMessage("Signed in with Google!");
        } catch (error) {
          showMessage(error.message, "error");
        } finally {
          document.getElementById("google-login-btn").textContent = "Sign In with Google";
        }
      };

      // Banner logout button
      document.getElementById("banner-logout-btn").onclick = async () => {
        try {
          if (window.currentUser) {
            await removeUserSession(window.currentUser.uid);
          }
          await signOut(auth);
          updateBannerStatus("Signed out successfully");
        } catch (error) {
          updateBannerStatus("Sign out failed");
          console.error("Sign out error:", error);
        }
      };

      // Auth state listener (Firebase handles persistence)
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // User signed in - update banner
          document.getElementById("banner-signed-out").style.display = "none";
          document.getElementById("banner-signed-in").style.display = "flex";
          document.getElementById("banner-user-name").textContent = 
            user.displayName || user.email.split("@")[0];
          document.getElementById("banner-user-avatar").textContent = 
            (user.displayName || user.email)[0].toUpperCase();

          updateBannerStatus("Account & sync management");
          closeModal();

          // Save session to Firebase (replaces localStorage)
          await saveUserSession(user);

          // Make user and Firebase available globally for quiz pages
          window.currentUser = user;
          window.auth = auth;
          window.db = db;

          console.log("User signed in:", user.email);
        } else {
          // User signed out - update banner
          document.getElementById("banner-signed-out").style.display = "flex";
          document.getElementById("banner-signed-in").style.display = "none";

          updateBannerStatus("Authentication System");
          window.currentUser = null;

          console.log("User signed out");
        }
      });

      // Make functions globally available
      window.openModal = openModal;
      window.closeModal = closeModal;

      console.log("Firebase-only authentication system loaded");
    </script>
  </body>
</html>
